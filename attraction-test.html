<!doctype html>
<html>
  <head>
    <title>Model a 2d grid of spring-connected particles</title>
  </head>
  <body>
    <h1>Attraction</h1>
    <canvas id="main" width="400" height="400" style="border:1px solid black;"></canvas>
    <p>Click to move big mass. Shift-click to move small mass.</p>
    <script type="text/javascript" src="third-party/require.js"></script>
    <script type="text/javascript">

      require({

        baseUrl: './src',
        jQuery: false,
        paths: {
          'RAF': '../third-party/requestAnimationFrame',
          'jquery': '../third-party/jquery-1.7.1.min',
          'underscore': '../third-party/underscore',
          'prettify': '../third-party/prettify/prettify',
          'text': '../third-party/text',
          'Physics': 'physics/Traer'
        },

        priority: ['jquery', 'underscore']

      });

      require([
        'Physics',
        'RAF',
        'jquery',
        'underscore',
      ], function(Physics, raf) {

        // Size of canvas
        var CANVAS_WIDTH;
        var CANVAS_HEIGHT;

        // Size of grid
        var GRID_SIZE = 10;

        // Physics constants
        var PHYS_GRAVITY = 0;
        var PHYS_DRAG = 0.01;
        var SPRING_STRENGTH = 0.2;
        var SPRING_DAMPING = 0.1;

        // Globals
        var physics;                // ParticleSystem
        var canvas;                 // HTML5 canvas element
        var ctx;                    // 2d drawing context of canvas element
        var mouseX = null;          // last user x mouse coordinate
        var mouseY = null;          // last user y mouse coordinate
        var small = null;           // reference to small particle
        var big = null;             // reference to big particle
        var movingParticle = null;  // reference to particle user is currently dragging

        init();
        draw();

        function init() {

          canvas = document.getElementById('main');

          CANVAS_WIDTH = canvas.width;
          CANVAS_HEIGHT = canvas.height;

          ctx = canvas.getContext('2d');
          ctx.fillStyle = 'black';
          ctx.strokeStyle = 'black';

          // Mouse Interactions

          $(canvas)
            .bind('mousedown', onCanvasMouseDown)
            .bind('mousemove', onCanvasMouseMove)
            .bind('mouseup', onCanvasMouseUp);

          // Init particle system
          physics = new Physics.ParticleSystem(PHYS_GRAVITY, PHYS_DRAG);

          // Init particles
          big = physics.makeParticle(4.0, CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 100);
          small = physics.makeParticle(0.2, CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);

          // Make attraction
          physics.makeAttraction(big, small, -50.0, 100.0);

        }

        function onCanvasMouseDown(e) {
          movingParticle = e.shiftKey ? small : big;
          mouseX = e.clientX;
          mouseY = e.clientY;
          onCanvasMouseMove(e);
        }

        function onCanvasMouseMove(e) {
          if (mouseX === null || mouseY === null) {
            return;
          }
          mouseX = e.clientX;
          mouseY = e.clientY;
          mouseX -= $(canvas).offset().left - $(window).scrollLeft();
          mouseY -= $(canvas).offset().top - $(window).scrollTop();
          movingParticle.position.set(mouseX, mouseY);
          movingParticle.velocity.clear();
        }

        function onCanvasMouseUp(e) {
          mouseX = null
          mouseY = null;
        }

        function draw() {

          physics.tick();

          ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

          ctx.beginPath();
          ctx.arc(big.position.x, big.position.y, 50, 0, Math.PI * 2.0, false);
          ctx.closePath();
          ctx.fill();

          ctx.beginPath();
          ctx.arc(small.position.x, small.position.y, 10, 0, Math.PI * 2.0, false);
          ctx.closePath();
          ctx.stroke();

          raf(draw);

        }

      });

    </script>
  </body>

</html>